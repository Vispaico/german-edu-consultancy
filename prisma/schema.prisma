generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Models
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  phone         String?
  role          Role      @default(STUDENT)
  emailverified DateTime?
  image         String?
  createdat     DateTime  @default(now())
  updatedat     DateTime  @updatedAt

  // Relations
  blogposts     BlogPost[]
  student       Student?
  consultant    Consultant?
  sessions      Session[]
  verificationTokens VerificationToken[]
}

enum Role {
  STUDENT
  CONSULTANT
  ADMIN
}

model Session {
  id           String   @id @default(cuid())
  sessiontoken String   @unique
  userid       String
  expires      DateTime
  user         User     @relation(fields: [userid], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String
  token      String   @unique
  expires    DateTime
  userid     String
  user       User     @relation(fields: [userid], references: [id], onDelete: Cascade)

  @@unique([identifier, token])
}

// Student Profile
model Student {
  id               String   @id @default(cuid())
  userid           String   @unique
  user             User     @relation(fields: [userid], references: [id], onDelete: Cascade)

  // Personal Information
  firstname        String
  lastname         String
  dateofbirth      DateTime
  nationality      String   @default("Vietnam")
  passportnumber   String?
  gender           String?
  address          String?
  city             String?

  // Academic Information
  education        String?
  major            String?
  gpa              Float?

  // German Test Scores
  testdafscore     String?
  goethescore      String?

  createdat        DateTime @default(now())
  updatedat        DateTime @updatedAt

  // Relations
  applications     Application[]
  documents        Document[]
  testbookings     TestBooking[]
  messages         Message[]
  payments         Payment[]
}

// Consultant Profile
model Consultant {
  id          String   @id @default(cuid())
  userid      String   @unique
  user        User     @relation(fields: [userid], references: [id], onDelete: Cascade)

  specialization String?
  experience     Int?

  createdat   DateTime @default(now())
  updatedat   DateTime @updatedAt

  // Relations
  applications Application[]
  messages     Message[]
}

// University
model University {
  id              String   @id @default(cuid())
  name            String
  nameVi          String?
  slug            String   @unique
  city            String
  state           String
  country         String   @default("Germany")

  logo            String?
  website         String?
  ranking         Int?

  description     String?
  descriptionVi   String?

  requirements    String?  // JSON string

  createdat       DateTime @default(now())
  updatedat       DateTime @updatedAt

  // Relations
  courses         Course[]
  applications    Application[]
}

// Course/Program
model Course {
  id            String   @id @default(cuid())
  universityid  String
  university    University @relation(fields: [universityid], references: [id], onDelete: Cascade)

  name          String
  nameVi        String?
  degree        String   // Bachelor, Master, PhD
  duration      Int      // Months
  tuition       Int      // EUR per year

  description   String?
  requirements  String?  // JSON string

  createdat     DateTime @default(now())
  updatedat     DateTime @updatedAt

  // Relations
  applications  Application[]
}

// Application
model Application {
  id              String   @id @default(cuid())
  studentid       String
  student         Student  @relation(fields: [studentid], references: [id], onDelete: Cascade)

  universityid    String
  university      University @relation(fields: [universityid], references: [id])

  courseid        String?
  course          Course?  @relation(fields: [courseid], references: [id])

  consultantid    String?
  consultant      Consultant? @relation(fields: [consultantid], references: [id])

  // Application Details
  status          ApplicationStatus @default(DRAFT)
  intake          String   // e.g., "Winter 2025"
  visastatus      VisaStatus @default(NOT_STARTED)

  // Tracking
  submittedat     DateTime?
  offerreceivedat DateTime?
  visaappliedat   DateTime?
  visaapprovedat  DateTime?

  notes           String?

  createdat       DateTime @default(now())
  updatedat       DateTime @updatedAt

  // Relations
  documents       Document[]
  payments        Payment[]
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  OFFER_RECEIVED
  OFFER_ACCEPTED
  VISA_PROCESSING
  APPROVED
  REJECTED
  WITHDRAWN
}

enum VisaStatus {
  NOT_STARTED
  DOCUMENTS_PREPARATION
  SUBMITTED
  BIOMETRICS_DONE
  MEDICAL_DONE
  PROCESSING
  APPROVED
  REJECTED
}

// Document
model Document {
  id              String   @id @default(cuid())
  studentid       String
  student         Student  @relation(fields: [studentid], references: [id], onDelete: Cascade)

  applicationid   String?
  application     Application? @relation(fields: [applicationid], references: [id])

  type            DocumentType
  name            String
  filename        String
  fileurl         String
  filesize        Int      // Bytes

  status          DocumentStatus @default(PENDING)
  verifiedat      DateTime?
  verifiedby      String?

  notes           String?

  createdat       DateTime @default(now())
  updatedat       DateTime @updatedAt
}

enum DocumentType {
  PASSPORT
  TRANSCRIPT
  DIPLOMA
  IELTS_CERTIFICATE
  TOEFL_CERTIFICATE
  PTE_CERTIFICATE
  TESTDAF_CERTIFICATE
  GOETHE_CERTIFICATE
  RECOMMENDATION_LETTER
  PERSONAL_STATEMENT
  CV
  FINANCIAL_PROOF
  BIRTH_CERTIFICATE
  VISA_APPLICATION
  MEDICAL_CERTIFICATE
  POLICE_CHECK
  OTHER
}

enum DocumentStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

// Language Test Booking
model TestBooking {
  id          String   @id @default(cuid())
  studentid   String
  student     Student  @relation(fields: [studentid], references: [id], onDelete: Cascade)

  testtype    TestType
  testcenter  String
  location    String
  testdate    DateTime

  registrationid String?
  status      BookingStatus @default(PENDING)

  score       Float?
  resultdate  DateTime?

  notes       String?

  createdat   DateTime @default(now())
  updatedat   DateTime @updatedAt
}

enum TestType {
  IELTS_ACADEMIC
  IELTS_GENERAL
  TOEFL_IBT
  PTE_ACADEMIC
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

// Payment
model Payment {
  id              String   @id @default(cuid())
  studentid       String
  student         Student  @relation(fields: [studentid], references: [id], onDelete: Cascade)

  applicationid   String?
  application     Application? @relation(fields: [applicationid], references: [id])

  amount          Int      // VND
  type            PaymentType
  method          PaymentMethod

  status          PaymentStatus @default(PENDING)

  // Bank Transfer Details
  bankname        String?
  accountnumber   String?
  transfercode    String?
  transferdate    DateTime?

  // Receipt
  receipturl      String?

  verifiedat      DateTime?
  verifiedby      String?

  notes           String?

  createdat       DateTime @default(now())
  updatedat       DateTime @updatedAt
}

enum PaymentType {
  CONSULTATION_FEE
  APPLICATION_FEE
  VISA_SUPPORT_FEE
  DOCUMENT_TRANSLATION
  TEST_REGISTRATION
  OTHER
}

enum PaymentMethod {
  BANK_TRANSFER
  VIETQR
  MOMO
  ZALOPAY
  CASH
}

enum PaymentStatus {
  PENDING
  VERIFIED
  COMPLETED
  REJECTED
  REFUNDED
}

// Message/Chat
model Message {
  id          String   @id @default(cuid())
  studentid   String
  student     Student  @relation(fields: [studentid], references: [id], onDelete: Cascade)

  consultantid String?
  consultant   Consultant? @relation(fields: [consultantid], references: [id])

  content     String
  isfromstudent Boolean @default(true)

  readat      DateTime?

  createdat   DateTime @default(now())
}

// Blog Post (with language separation)
model BlogPost {
  id          String   @id @default(cuid())
  slug        String

  // Language identifier (en or vi)
  language    String   @default("en")

  // SEO fields
  metatitle   String?
  metadescription String?

  // Content fields
  title       String
  excerpt     String?
  content     String

  // Images
  coverimage  String?
  authorid    String?

  // Category and tags
  category    String?
  tags        String?  // JSON array: ["留学", "签证", "Ausbildung"]

  // Publishing
  published   Boolean  @default(false)
  publishedat DateTime?
  views       Int      @default(0)

  // Timestamps
  createdat   DateTime @default(now())
  updatedat   DateTime @updatedAt

  // Relations
  author      User?    @relation(fields: [authorid], references: [id], onDelete: SetNull)

  // Unique constraint: same slug + language = same article in different languages
  @@unique([slug, language])
}

// Newsletter subscribers
model Newsletter {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String?
  subscribedat DateTime @default(now())
  active      Boolean  @default(true)
  ipaddress   String?
  unsubscribetoken String?
  createdat   DateTime @default(now())
}

// Contact form messages
model ContactMessage {
  id          String   @id @default(cuid())

  // Contact information
  name        String
  email       String
  phone       String
  message     String

  // Tracking
  ipaddress   String?
  useragent   String?
  createdat   DateTime @default(now())

  // Status
  status      String   @default("new") // new, read, replied, closed
}
